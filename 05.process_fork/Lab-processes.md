## Оформление ответов по лабораторной работе
* Создать репозиторий на github.com или gitlab.com
* приложить в репозиторий  README.md с ответами и скриншотами экрана
* Задания отмеченные (*) являются дополнительными для самостоятельного разбора

---
## Утилиты для лабораторной

![test](images/img1.png)

```bash
df
du
cp
mv
ls
ln
ldd
free
dd
lsblk
blkid
parted
fdisk 
ps
pstree
top 
atop
iotop
htop
vmstat
pidstat
iostat

```
* Самоятельно посмотрите man по каждой

---

## Посмотрим какие дисковые устройства и партиции есть в системе

```bash
lsblk
blkid
fdisk -l 
parted -l
```
* Какой размер дисков?
* Есть ли неразмеченное место на дисках?
* Какой размер партиций?
* Какая таблица партционирования используется?
* Какой диск, партция или лвм том смонтированы в /

---

## (*) При налиичии свободного дискового пространства создадим файловую систему и lvm
* вам понадобятся команды: parted/fdisk/gdisk, pvcreate, lvreate, vgcreate, mkfs
* примонтируйте полученную файловую систему
* снимите снэпшот
* удалите файл
* примонтируйте снэпшот рядом
* проверьте что ваш файл доступен
* задокументируйте все в README

---

## Создадим сжатую файловую систему для чтения squashfs
```bash
git clone https://gitlab.com/erlong15/mai.git
mksquashfs mai/* mai.sqsh
sudo mkdir /mnt/mai
sudo mount mai.sqsh /mnt/mai -t squashfs -o loop
```

---

## Посмотрим информацию по файловым системам смонтированным в системе

```bash
df -h
df -i
mount
```
* Какая файловая система примонтирована в /
* С какими опциями примонтирована файловая система в /
* Какой размер файловой системы приментированной в /mnt/mai

---

## Попробуем создать файлик в каталоге /dev/shm

```bash
dd if=/dev/zero of=/dev/shm/mai bs=1M count=100
free -h
rm -f /dev/shm/mai
free -h
```
* Что такое tmpfs
* какая часть памяти изменялась?

---

## Изучим процессы запущенные в системе

```bash
ps -eF
ps rx 
ps -e --forest
ps -efL
```

* Какие процессы в системе порождают дочерние процессы через fork
* Какие процессы в системе являются мультитредовыми

---

## Разберитесь что делает команда

```bash
ps axo rss | tail -n +2|paste -sd+ | bc
```

* Что подсчитывается этой командой
* Почему цифра такая странная

---

## Уставновим утилиту smem и проанализируем параметр PSS в ней
```bash
apt-get install smem -y
smem
```
* утилита работает какое то время, можно оставить ее в другом терминале

---

## Запустим приложеннный скрипт и понаблюдаем за процессами
```bash
python myfork.py
```
* в другом терминале  отследите порождение процессов
* отследите какие состояния вы видите у процессов
* почему появляются процессы со статусам Z
* какой PID у основного процесса
* убейте основной процесс ```kill -9 <pid>```
* какой PPID стал у первого чайлда
* насколько вы разобрались в скрипте и втом что он делает?

---

## Научимся корректно завершать зомби процессы
* запустим еще раз наш процесс
* убьем процесс первого чайлда
* проверим его состояние  и убедимся что он зомби
* остановим основной процесс
* расскоментируем строки в скрипте
```python
      pid, status = os.waitpid(pid, 0)
      print("wait returned, pid = %d, status = %d" % (pid, status))
```
* поторим все еще раз
* отследим корректное завершение чайлда

---
## Научимся убивать зомби процессы
* запускаем процессс еще раз
```bash
gdb
> attach <parent_PID>
> call waitpid(zombie_PID, 0, 0) wait
> detach
> quit
```

---
## Проблемы при отмонтировании директории
```bash
cd /mnt/mai
# в другом терминале
sudo umount /mnt/mai
fuser -v /mnt/dir
```
* Напишите какие процессы мешают размонтировать директорию
* посмотрите ```lsof -p <pid>``` этих процессов
* убейте мешаюший процесс и размонтируйте директорию

---

## Решаем загадку исчезновения места на диске
* создадим директорию ~/myfiles
* запустим файл test_write.py из ранее созданной директории
* проверим в другом терминале что в этой директории создался файл и он увеличивается в размере
* в первом терминали нажмем Ctrl+Z
* проверим статус файла
* выполним команды
```bash
jobs -l
fg
```
* eще раз остановим  процесс черерз CTRL+Z
* выполним команду ```bg```
* проверим размер файловой системы и каталога
```bash
df 
du -sh  ~/myfiles
```
* удалим файл
* повторно проверим размеры кталога и файловой системы
* Какую систуацию вы видите, как вы это объясните
* Подключитесь к процессу через ```strace -p <pid>``` и назовите дескриптор файла, куда пишет процесс
* проверим какие файлы открыты у нашего процесса через команду lsof -p <pid>
* убьем процесс
* еще раз прорим размер файловой системы и каталога
* Напишите свое объяснение, что произошло

---

## Утилиты наблюдения
* C помощью утилит мониторинга 
* проверьте текущий LA 
* запишите top 3 процессов загружающих CPU
* запишите top 3 процессов загружающих память 
* запустите утилиту atop как сервис через systemd
* запустите dd на генерацию файла размер в 3 гигабайта
* удалите сгенеренный файл
* через atop скажите какой  pid был у процесса
* Проанализируйте нагрузку на диск через утилиты  iotop и iostat
