## Домашнее задание
Настраиваем бэкапы с помощью BorgBackup  
Настроить стенд Vagrant с двумя виртуальными машинами server и backup.  
  
Настроить политику бэкапа директории /etc с клиента (server) на бекап сервер (backup):  
1) Бекап делаем раз в час  
2) Политика хранения бекапов: храним все за последние 30 дней, и по одному за предыдущие два месяца.  
3) Настроить логирование процесса бекапа в /var/log/ - название файла на ваше усмотрение  
4) Восстановить из бекапа директорию /etc с помощью опции Borg mount  
  
Результатом должен быть скрипт резервного копирования (политику хранения можно реализовать в нем же), а так же вывод команд терминала записанный с помощью script (или другой подобной утилиты)  
  
\* Настроить репозиторий для резервных копий с шифрованием ключом.  
  
** Настроить резервирование логического бекапа базы данных ( база на ваш выбор ) с помощью BorgBackup  

## Решение 
Задание выполнено с использованием `ansible`, для запуска скрипта ([backup-data.sh](https://github.com/dbudakov/17.backup/blob/master/homework/scripts/backup-data.sh)) используются юниты `systemctl`(можно посмотреть здесь [service](https://github.com/dbudakov/17.backup/blob/master/homework/roles/templates/borg_backup.service) и [timer](https://github.com/dbudakov/17.backup/blob/master/homework/roles/templates/borg_backup.timer)). Cкрипты во время деплоя кладутся в `/root/scripts/`, логи собирают вывод результата работы скрипов и кладутся в каталоги `/var/log/backup-etc` и `/var/log/backup-sql`, имена логов аналогичны именам бэкапов и завися от даты  
Для проверки на восстановление из бэкапа через `borg mount`, необходимо запустить скрипт([borg_mount.sh](https://github.com/dbudakov/17.backup/blob/master/homework/scripts/borg_mount.sh)) с сервера `files`:  
```
/bin/bash /root/scripts/borg_mount.sh
## ВНИМАНИЕ: скрипт может не отработать, из-за активности `borg`, необходимо запустить скрипт повторно!   
```
В результате будет показан список файлов из смонтированного бэкапа в директорию /mnt, но работать с этой дирректорией нужно от пользователся borg, т.к. на него завязана вся работа с бэкапами.   

Для `psql` снимается дамп и аналогично отправляется на backup'сервер репозиторий `backup:file-sql`    
Репозитории зашифрованы, через `repokey-blake2`, и для работы с ними нужны сгенерированные ключи помимо passphrase   
Требуемая политика хранения бэкапов соблюдена через атрибуты  `--keep-within=30d` и `--keep-monthly=2`  
```
borg prune \
  -v --list --show-rc \
  --keep-within=30d \
  --keep-monthly=2 \ 
  ${BACKUP_USER}@${BACKUP_HOST}:${BACKUP_REPO} 2>>/var/log/backup-etc/etc_backup-${LOGFILE}
```

Все созданные пользователи, а это `borg/postgres`, имеют пароль `vagrant`    
passphrase для работы с репозиториями `1234`    

