# DHCP
Суть процесса получения адреса по DHCP описана в RFC 2131([Request for Comments: 2131 ](https://tools.ietf.org/html/rfc2131))  
DHCP работает только в пределах действия широковещательного домена,если есть ограничения физического сегмента или VLAN'а, то и работать DHCP будет в пределах этого VLAN'a.![](https://github.com/dbudakov/23.DNS/blob/master/images/DHCP/DHCP.png)  
Итак первый запрос 'DHCP Discover' идет с неназначеного адреса на броадкастовый адрес(255.255.255.255).Cуть первого запроса в том чтобы клиент обозначил себя и запрос на получения адреса. В ответ DHCP сервер делает широковещательную рассылку 'DHCP Offer(Unicast/Broadcast)' броадкастом(так как адреса у источника запроса нет) и предлагает использовать конкретный адрес. Далее клиент в случае отсутствия ограничений, отправляет широковещательной(broadcast) запрос на использование указанного(ранее предложенного) адреса 'DHCP Request(Broadcast)'. На что сервер подтверждает использование этого адреса(DHCP Ack(Unicast/Broadcast))   

# DHCP relay
ВАЖНЫЕ МОМЕНТЫ:  
    - настройка dhcrelay  
    - настройка dhcp для сегмента  
    - маршруты в нужный сегмент  
  ![](https://github.com/dbudakov/23.DNS/blob/master/images/DHCP/DHCP_relay_2.png)  
В случае если несколько сегментов сети, а DHCP один, то используется DHCP relay, он настравается на любой машине, даже без forwarding'a, при помощи специального демона, который в рамках своего сегмента отлавливает Broadcast'овые запросы и отправляет их DHCP серверу, соответственно ответ он DHCP сервера возвращается по Unicast адресу, принадлежащему DHCP relay, и он их возвращает клиенту в рамках своего сегмента  
  ВАЖНО: IP src(соурс адрес) приходящий на DHCP сервер имеет адрес принадлежащий внутреннему сегменту сети(60.10 на рисунке 2), поэтому если DHCP сервер ничего не знает об этом сегменте, то ответа не будет, при масштабировании разумно использовать динамическую маршрутизацию  

DHCP relay config
--------
Входит в пакет `dhcp`. Для настройки создается юнит файл для systemd:    
```
##/etc/systemd/system/dhcrelay.service  
[Unit]  
Description=DHCP Relay Agent Daemon  
Documentation=man:dhcrelay(8)  
Wants=network-online.target  
After=network-online.target  
 
[Service] 
Type=notify
## говорит о том что запускается `dhcrelay` в режиме демона(-d), пид ему не нужен(--no-pid), адрес сервера на который нужно пересылать запросы(192.168.50.10) и интерфейсы, которые участвуют в таком обмене(-i eth2 -i eth1)
ExecStart=/usr/sbin/dhcrelay -d --no-pid 192.168.50.10 -i eth2 -i eth1
[Install]
WantedBy=multi-user.target
```
Корректный файл(источник) лежит в /usr  


DHCP config for relay  
--------
Если посмотреть на клиента получившего адрес, то он будет из соответсвующей(60) подсети, виной тому источник - 60 сетка. Посмотрим конфиг DHCP сервера, откуда увидим что есть соответсвующая настройки, какие адреса выдавать в случае если источни из 60 подсети.  
Все реализуется настройкой для каждого сегмента.    
```
## /etc/dhcp
subnet 192.168.60.0 netmask 255.255.255.0 {
  range 192.168.60.100 192.168.60.199;
  option subnet-mask 255.255.255.0;
  option routers 192.168.60.10;
  get-lease-hostnames true;
  use-host-decl-names true;
  default-lease-time 600;
  max-lease-time 7200;

  host client 3 {
    hardware ethernet AA:01:CC:16:B4:F5;
    fixed-address 192.168.60.199;
      }
  }
```

DHCP relay VLAN  
---
Работает аналогично сегментам, на схеме свич 3 уровня, который маршрутизирует DHCP пакеты между сегментами  
![](https://github.com/dbudakov/23.DNS/blob/master/images/DHCP/DHCP_relay_3.png)  
