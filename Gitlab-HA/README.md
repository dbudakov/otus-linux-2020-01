# Gitlab-HA

Есть схема в темном цвете, лежит в `./images`

`pg1` - выступает в роли DNS

На каждом сервере Postgres подключение осуществляется через `pgbouncer`, который слушает все адреса на `:6432` и подключает сессии через `localhost:5432`
Есть зависимые узлы, во-первых в каждом узле разворачивается узел с именем`*1` , а затем `*2`. Во вторых для деплоя узла `git`, необходимо поднять сначала `pg1`-> `node1` -> `node2` -> {`git1`|`git2`}. Можно деплоить по отдельность узлы `pg`, `node`, `nginx`, но поднять для них `pg1` - выступающий в роли ДНС(соответствие ДНС имен адресам есть на этом [слайде](https://github.com/dbudakov/Gitlab-HA/blob/master/images/project_dark_dns.jpg).
![](https://github.com/dbudakov/Gitlab-HA/blob/master/images/project_white.jpg)

### Дополнительно
Возможно `pacemaker` при работе с ресурсом PostgreSQL, требуется запись в pg_hba.conf вида

```
local all     postgres                            peer
```

После перевода Базы на слейв, упавший мастер поднимится уже слейвом, чтобы вернуться исходное положение нужно
запускать скрипт инициализации мастера, и выполнить `pcs resource refresh`
[Redis](https://club.directum.ru/post/222438)

### важные моменты

Когда запускается redis в слейв режиме на сервере приложения, сервер приложений становиться не доступен, до того момента пока скрипт redis sentinel не выведет узел в режим Мастера
