Мосты тунели и VPN
  Технологии нужные, такаже нужны навыки для защиты и масштабирования сети

Bridge:
  Способ объединения сегментов сети на каналоном уровне(L2) без использования протоколов более высокого уровня, хосты общаются по L2 и общение идет только внутри одной сети, сети не могут быть разными
  При создании сети, есть момент в котором следует указываеть не шлюзовые интерфейсы а ip бриджа.
  Также бриджи используются внутри одного хоста для объединения виртуалок или контейнеров
  На бридж необязательно назначать ip адрес, он только соединяет сети.


  Пакеты передаются на основе MAC, а не IP.
  настройка через утилиты iproute2(ip link) или brctl(bridge-utils)
  можно объединить: L2-интерфейсы(eth,tap,wi-fi)
  можно объединить до 1024 интерфейсов
  нульзя объединить:L3-интерфейсы(tun,ppp)

  ВАЖНО:
    - избегать создания петель(луп,кольцо) с помощью bridge-интерфейсов
    - использовать протокол STP(spanning three) - ликвидирует петли

Туннелирование:
  Процесс, в ходе которого создаётся логическое соединение между двумя конечными точками посредством инкапсуляции различных протоколов

  Особенности:
    - используют инкапсуляцию протоколов
    - протоколы, реализующие туннелирование могут работать на L4 и L7

  Примеры:
    IPIP Tunnel (site to site) (47 стр, 00:37)
      Особенности:
        - инкапсулирует только unicast IPv4-трафик
        - для работы требут внешние IP-адреса
        - не имеет механизмов для работы через NAT
        - так как не пропускает multicast, то мешает работе VRRP и OSPF
        - реализован в Linux и на оборудовании некоторых вендоров(Cisco, Mikrotik)
        - не имеет собственных механизмов шифрования
        - не требователен к ресурсам оборудования

    GRE
      Generic Routing Encapsulation - общая инкапсуляция маршрутов

      Особенности:
        - инкапсулирует пракически любой IPv4-трафик(в том числе multicast)
        - для работы требует внешние IP-адреса
        - не имеет механизмов для работы через NAT
        - реализован в Linux и на оборедовании многих вендоров
        - не имеет собственных механизмов шифрования
        - не требователен к ресурсам

  Принцип:
    Для создания туннелей применяют виртуальные интерфейсы, драйверы которых упаковывают(инкапсулируют) принятые данные в IP-пакет и отправляют снова на маршрутизацию, а также в обратном порядке

  Недостатки:
    - безопасность(решается применением например IPsec)
    - сложность масштабирования
    - ограничения в построении сложных топологий
    - отсутствие отказоустойчивасти(stateless или connectionless), почти не возможно локализовать проблему с линией, единственное через маршрутизацию найти нестабильную точку

VPN:
  Virtual Private Network( англ. виртуальные частные сети) - обобщённое название технологий, позволяющих обеспечить одно или несколько  сетевых соединений(логическую сеть) поверх другой сети(напр. Интернет)

  Назначение:
    - формируют логические связи независимо от физической среды
    - позволяют обойстись без выделенных каналов
    - позволяют защитить инфраструктуру


IPsec
  IP Security - набор протоколов для обеспечения защиты данных

  Особенности:
    - отсутствие виртуальных интерфейсов(если используются только IPsec в чистом виде)
    - маршрутизация осуществляется с помощью ACL и Crypto map
    - допускает применение протоколов динамической маршрутизации

  Реализации в Linux
    iproute2
    strongSwan (https://www.strongswan.org), openswan/lightswan
    softether (https://www.softether.org)

  Режимы:
    Транспортный режим - защищается только  полезная нагрузка пакета, оставляя оригинальный заголовок. Для построения туннелей транспортный режим обычно используется в связке с IPIP или GRE, полезная нагрузка которых уже содержит весь исходнный пакет

    Туннельный режим - полностью инкапсулирует исходный пакет в новый(по аналогии с GRE или IPIP). Но для туннельного IPsec не создается явного интерфейса в системе, это может быть проблемой если используется динамическая или сложная статическая маршрутизация

  Преимущества:
    - работает на сетевом уровне модели OSI
    - может шифровать исходный пакет целиком либо от транспортного уровня и выше
    - присутствует механизм преодоления NAT
    - большой набор алгоритмов шифрования и хэширования трафика на выбор
    - хорошая соотношение скорости работы, связанность машин и сетевых аппаратных устройств

  Недостатки:
    - сложность
    - различная терминология и инструменты конфигурации у различных вендоров
    - использование сильных алгоритмов шифрования требует ресурсов
    - легко обнаруживает DPI

OpenVPN
  Сайт проекта:
    https://openvpn.net

  Wiki проекта:
    https://community.openvpn.net/openvpn/wiki

  Особенности:
    - реализует все типы защищенных каналов(clietn to server, server to server)
    - TCP или UDP в качестве транспорта
    - работает через NAT
    - L2 и L3 туннели
    - шифрование с использование OpenSSL
    - кроссплатформенный клиент
    - задействует только одно ядро(в микротик/CCR)

  Аутентификация:
    Static key:
      - простота настройки
      - используется при site-to-site подключениях для создания full-mesh VPN-сетей
      - нет необходимости в X.509 PKI инфраструктуре

    Certificate-based:
      - гибко настраивается
      - требует выдачи сертификатов и приватных ключей клиентам(но можно всё упаковать в один файлик)
      - требует развертывания X.509 PKI инфраструктуры
      - удобно использовать в случае отсутствия доверия к клиентам(просто необходимо отозвать ключ, и пользователь не зайдет)

    Авторизация по логину-паролю:
      - упрощает процесс подключения клиентов
      - не требует ключей и сертификатов (кроме корневого)
      - не так безопасно

  Интерфейсы:
    tun-интерфейс
      - виртуальный интерфейс, работает на L3
      - универсален с точки зрения типа и устройства подключения
      - не позволяет! использовать linkstate протоколы динамической маршрутизации
      - для маршрутизации лучше использовать iBGP

    tap-интерфейс
      - виртуальный интерфейс, работает на L2
      - по сути представляет собой бридж между роутерами
      - подходит для проброса vlan'ов
      - позволяет! использовать linkstate протоколы динамической маршрутизации

  Режим работы интрефейсов:
    Topology:
      P2P(peer-2-peer):
        - каждое подключение имеет свой tun(tap) интерфейс
        - роутинг и свитчинг осуществляются на сторне ОС
        - основной режим в site-2-site конфигурации

      Subnet:
        - реализует виртуальная сеть
        - маршрутизация происходит внутри openvpn-server'a
        - для общения openvpn-клиентов между собой нужно включать опцию client-to-client
        - используется в server-to-client конфигурации
    Разница в том что в P2P все трафик маршрутизируется средствами операционной системы, а в случае Subnet этим занимается демон openvpn

WireGuard
  Модуль WireGuard включен в ядро Linux начина с версии 5.6
  Официальлный сайт: https://www.wireguard.com

  Преимущества:
    - простой в использовании
    - использует современную криптографию
    - компактны читаемый код(отсутствие legacy)

  Производительность:
    - высокая производительность на Linux, так как работает на уровне ядра

  Недостатки:
    - отсутствие поддржки устройсвами различных вендоров
    - сам продукт WireGuard не проходил аудит безопасности, аудит безопасности проходили используемые протоколы
    - нет возможности менять используемые криптопримитивы и транспортный протокол

  Дебаг отладка openvpn:
    1. порт виден и до него можно достучаться с клиента
      nmap'ом смотрим открыт ли порт на удалённом серваке
    2. проверяем сформированный туннелльный интерфейс
      аналогично локально
        ss -ntplu / netstat -ntplu - слушает udp порт
    3. Должна быть связанность туннельных ip, внутри тунелля
    Если порты не прослушаваются, значит сервис не запустился, тогда смотрим логи или запускаем в режиме debug'a, а также проверить маршруты

Тестирование каналов:
  iperf3 - утилита для проверки каналов
  sudo ping -f - флуд пинг



~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Дополнительно:
  Для объединения филиалов могут использоваться технологии:
    - site-to-site vpn
    - l2tp+ipsec
    - openvpn
    - wireguard
    - ip-ip тонель

Новые понятия:
colocation
sstp
ipsec,gre
VRRP
ospf может работать через GRE и IPIP
MESH
snmp
Зуксель/strongSwan
DPI
vpn + ipsec hybrid RSA
SIP
GITR/JITR(джиттер)
pfsense умеет делать exe'шник для клиента openvpn со всеми настройками внутри
Easy RSA( по openvpn пролетают LDAP запросы)
full mesh
01:35 кейс на проброс vlan чтобы подрубиться аналогично патч-корду находясь далеко
bad chksum может быть в том случае если crc считается аппаратными средствами сетевой
fullduplex - прямая и обратная связь
CCR
Jason A. Donenfeld - WireGuard
кинетик ОС
tcpdump -nvvv -As0 -ieth1 - более детальный вывод
tcpdump -nvvv -As0 -x -ieth1 - и ещё более детальный вывод
tshark
netgrep
ipperf
tmux/terminar
MUM microtik
vrf для пересекающихся сетей


Дополнительные материалы:

Сайт: https://asp24.ru/mikrotik/vpn/obzor-ipsec-v-mikrotik
Сети для самых маленьких. Часть 7. VPN: https://habr.com/ru/post/170895/
Сайт: http://xgu.ru/wiki/VPN
Сайт: http://xgu.ru/wiki/OpenVPN
https://www.digitalocean.com/community/tutorials/openvpn-ubuntu-16-04-ru
